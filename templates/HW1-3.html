<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Grid World Reinforcement Learning</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        background-color: #e4ebf5;
        align-items: center;
        height: 100vh;
        width: 100vw;
        background-image: url("./pat-back.svg");
      }
      .grid-container {
        padding-top: 2rem;
        justify-content: center;
        align-items: center;
        width: 80vw;
        display: grid;
        grid-template-columns: repeat(7, 50px); /* 修改为 50px */
        grid-template-rows: repeat(7, 50px); /* 修改为 50px */
        gap: 1px;
      }
      .grid-item {
        width: 50px;
        height: 50px;
        background-color: #e4ebf5;
        border: 1px solid #000000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        font-weight: bold;
      }
      p {
        line-height: 0.1;
        font-size: 1.5rem;
      }
      ol {
        padding: 0 2rem;
      }
      li,
      label,
      input,
      button {
        font-size: 1.3rem;
      }
      .tag{
        box-shadow: inset 0.2rem 0.2rem 0.5rem #cfd8e6, inset -0.2rem -0.2rem 0.5rem #fff;
        padding: .5rem;
        width: 5rem;
        align-items: center;
        justify-content: center;
        display: flex;
        border-radius: 10px;
      }
      #tag {
        color: #5b0eeb;
        font-weight: bold;
        font-size: 1.2rem;
      }
      .point {
        color: green; 
        background-color: aquamarine; 
        padding: 0 .7rem; 
        font-weight: bold;
        border-radius: 6px;
      }

      .container {
        border-radius: 3rem;
        width: 90vw;
        height: 90vh;
        padding: 1rem 4rem;
        display: grid;
        box-sizing: border-box;
        box-shadow:
          0.8rem 0.8rem 1.4rem #cfd8e6,
          -0.2rem -0.2rem 1.8rem #fff;
      }
      .titleBox {
        width: 100%;
        align-items: center;
        justify-content: center;
        display: flex;
        font-size: 1.5rem;
      }
      .infoBoxs {
        display: flex;
      }

      /* .btn {
        border: none;
        border-radius: 40px;
      } */

      .btn {
        /* flex: 1; */
        border: none;
        width: 10rem;
        height: 3rem;
        border-radius: 1rem;
        box-shadow: .3rem .3rem .6rem  #c8d0e7;
        justify-self: center;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: .3s ease;

          grid-column: 1 / 2;
          grid-row: 4 / 5;
          background: #6d5dfc;  
          box-shadow:inset .2rem .2rem 1rem #8abdff,
                    inset -.2rem -.2rem 1rem #5b0eeb,
                    .3rem .3rem .6rem  #c8d0e7;
          color: #E4EBF5;
      }
      .btn:hover{ color: #fff; }
      .btn:active {
        box-shadow:inset .2rem .2rem 1rem #5b0eeb,
                  inset -.2rem -.2rem 1rem #8abdff;
      }
      .btn__second{
        background: #e4ebf5;  
        color: #677596;
        box-shadow: 0.3rem 0.3rem 0.6rem #c8d0e7, -0.2rem -0.2rem 0.6rem #ffffff;

      }
      .btn__second:hover{ color: #6b53f9; }
      .btn__second:active {
        box-shadow: inset 0.3rem 0.3rem 0.6rem #c8d0e7, inset -0.2rem -0.2rem 0.6rem #ffffff;

      }

      form {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
      }
      .inputBox {
        flex: 2;
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: center; 

      }
      input {
        width: 10rem;
      }
      label {
        text-align: center;
      }


    </style>
  </head>
  <body>
    <div class="container">
      <div class="titleBox">
        <h2>HW1: Gridworld Environment and Value Iteration</h1>
      </div>

      <div class="infoBoxs">
        <div class="box">
          <div class="infoTitle">
            <div class="tag">
              <span id="tag">HW1-1</span>
            </div>
          </div>
          <div class="info">
            <ol>
              <li>
                用 Flask Web 生成 nxn 的網格圖，允許使用者指定維度「n」（從 3 到
                7）
              </li>
              <li>
                透過滑鼠點擊指定
                <span class="point" style="color: #228362;">起點(start)</span>
                和
                <span  class="point" style="color: #e72d2d; background-color: #ff9d9d;">終點(end)</span>
              </li>
              <li>然後點擊設定 n-2 個障礙灰色。</li>
            </ol>
          </div>
        </div>

        <div class="box">
          <div class="infoTitle">
            <div class="tag">
              <span id="tag">HW1-2</span>
            </div>
          </div>
          <div class="info">
            <ol>
              <li>
                顯示每個單元格隨機產生的操作（帶有上、下、左、右箭頭）作為策略
              </li>
              <li>使用策略評估來導出每個狀態的值V(s)</li>
            </ol>
          </div>
        </div>

        <div class="box">
          <div class="infoTitle">
            <div class="tag">
              <span id="tag">HW1-3</span>
            </div>
          </div>
          <div class="info">
            <ol>
              <li>利用價值迭代演算法導出最優策略並顯示動作</li>
              <li>在每個單元上顯示V(s)</li>
            </ol>
          </div>
        </div>
      </div>

      <div style="display: flex;align-content: center;align-items: center;justify-content: space-around;">
      <form
        style="padding-top: 2rem; padding-bottom: 2rem"
        id="gridSizeForm"
        action="/update_grid_size"
        method="POST"
      >
      <div class="inputBox">
        <label style="margin-right: 1rem;" for="gridSize">輸入維度 n (3-7):</label>
        <input
          type="number"
          id="gridSize"
          name="gridSize"
          min="3"
          max="7"
          required
          style="margin-right: 1rem;" 
        />
        <input class="btn btn__second" type="submit" value="取得 Grid" />
      </div>
        
      </form>

      <div style="display: flex;">
        <button class="btn" style="margin-right: 1rem" id="policyButton">
          Show Policy
        </button>
        <button id="valueButton" class="btn">Show Value</button>
      </div>
    </div>

      <div class="grid-container" id="gridContainer">
        <!-- JavaScript will add grid items here -->
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const gridContainer = document.getElementById("gridContainer");
        const gridSizeForm = document.getElementById("gridSizeForm");
        const policyButton = document.getElementById("policyButton");
        const valueButton = document.getElementById("valueButton");

        let gridSize = 5;
        let startCell = null;
        let endCell = null;
        let obstacles = [];

        function createGrid(size) {
          gridContainer.innerHTML = "";

          gridContainer.style.gridTemplateColumns = `repeat(${size}, 50px)`; /* 修改为 50px */
          gridContainer.style.gridTemplateRows = `repeat(${size}, 50px)`; /* 修改为 50px */

          for (let row = 0; row < size; row++) {
            for (let col = 0; col < size; col++) {
              const cell = document.createElement("div");
              cell.classList.add("grid-item");
              cell.dataset.row = row;
              cell.dataset.col = col;
              cell.addEventListener("click", handleCellClick);
              gridContainer.appendChild(cell);
            }
          }
        }

        function handleCellClick(event) {
          const clickedCell = event.target;
          const row = parseInt(clickedCell.dataset.row);
          const col = parseInt(clickedCell.dataset.col);

          if (!startCell) {
            startCell = clickedCell;
            startCell.style.backgroundColor = "#00FF00"; // 绿色
          } else if (!endCell) {
            if (clickedCell !== startCell) {
              endCell = clickedCell;
              endCell.style.backgroundColor = "#FF0000"; // 红色
            }
          } else {
            if (clickedCell !== startCell && clickedCell !== endCell) {
              obstacles.push(clickedCell);
              clickedCell.style.backgroundColor = "#808080"; // 灰色
            }
          }
        }

        function showPolicy() {
          const cells = gridContainer.querySelectorAll(".grid-item");
          cells.forEach((cell) => {
            if (
              cell !== startCell &&
              cell !== endCell &&
              !obstacles.includes(cell)
            ) {
              const actions = ["↑", "↓", "←", "→"]; // 上、下、左、右
              const randomAction =
                actions[Math.floor(Math.random() * actions.length)];
              cell.innerText = randomAction; // 显示随机动作
            }
          });
        }

        function showValue() {
          // 这里可以添加值迭代算法的逻辑，计算状态值 V(s)，并在每个格子上显示
          const cells = gridContainer.querySelectorAll(".grid-item");
          cells.forEach((cell) => {
            if (
              cell !== startCell &&
              cell !== endCell &&
              !obstacles.includes(cell)
            ) {
              // 这里暂时使用随机值代替实际的状态值
              const value = Math.random(); // 随机值
              cell.innerText = value.toFixed(2); // 显示状态值
            }
          });
        }

        gridSizeForm.addEventListener("submit", function (event) {
          event.preventDefault();
          const newGridSize = parseInt(
            document.getElementById("gridSize").value
          );
          if (newGridSize >= 3 && newGridSize <= 7) {
            gridSize = newGridSize;
            createGrid(gridSize);
            startCell = null;
            endCell = null;
            obstacles = [];
          } else {
            alert("Grid size must be between 3 and 7");
          }
        });

        policyButton.addEventListener("click", function () {
          if (startCell && endCell) {
            showPolicy();
          } else {
            alert("Please set start and end cells first!");
          }
        });

        valueButton.addEventListener("click", function () {
          if (startCell && endCell) {
            showValue();
          } else {
            alert("Please set start and end cells first!");
          }
        });

        // 创建初始网格
        createGrid(gridSize);
      });
    </script>
  </body>
</html>
